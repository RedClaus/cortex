---
project: Cortex
component: Docs
phase: Ideation
date_created: 2026-01-16T00:00:00
source: ServerProjectsMac
librarian_indexed: 2026-02-06T01:20:39.038231
---

# CortexAvatar v1.1 Execution Plan

**Version**: 1.1.0  
**Created**: January 7, 2026  
**Status**: PLANNING  
**Estimated Duration**: 8-10 days

---

## Executive Summary

This document outlines the phased implementation plan for CortexAvatar v1.1 features. The plan is designed for parallel execution where possible, with clear dependencies and acceptance criteria.

### Features to Implement

| # | Feature | Priority | Effort | Phase |
|---|---------|----------|--------|-------|
| 1 | Push-to-Talk Global Hotkey | HIGH | 1 day | 1 |
| 2 | Live Captions/Subtitles | HIGH | 0.5 day | 1 |
| 3 | System Tray Integration | MEDIUM | 0.5 day | 1 |
| 4 | Improved Barge-in (AEC) | HIGH | 2 days | 2 |
| 5 | Display Cache (History) | HIGH | 2 days | 3 |
| 6 | Wake Word Detection | HIGH | 2-3 days | 4 |

### First Principles Compliance

| Principle | Status | Notes |
|-----------|--------|-------|
| Local-First | ✅ | All data in `~/.cortexavatar/` |
| Single Binary | ⚠️ | Wake word requires optional Porcupine library |
| CortexBrain Owns Cognition | ✅ | History is "display cache", Brain is authoritative |
| A2A Protocol Interface | ✅ | No direct LLM calls from Avatar |
| Modular Architecture | ✅ | All features are toggleable |

---

## Phase 0: Planning & Setup (This Document)

**Duration**: 0.5 day  
**Status**: IN PROGRESS

### Deliverables
- [x] Feature analysis and prioritization
- [x] First principles compliance check
- [ ] Execution plan document (this file)
- [ ] Dependency audit
- [ ] Task breakdown with estimates

---

## Phase 1: Foundation Features

**Duration**: 2 days  
**Dependencies**: None  
**Parallelizable**: YES - All 3 features can be developed simultaneously

### 1.1 Push-to-Talk Global Hotkey

**Effort**: 1 day  
**Owner**: TBD

#### Requirements
- Register global hotkey (default: `Cmd+Shift+Space` on macOS)
- While held: activate listening mode
- On release: stop listening, trigger STT
- Configurable via `~/.cortexavatar/config.yaml`
- Visual feedback in UI when PTT active

#### Technical Approach
```
Library: golang.design/x/hotkey
Location: internal/hotkey/hotkey.go (new)
Integration: Call AudioBridge.StartListening() / StopListening()
Config: Add hotkey.enabled, hotkey.key_combo to config.go
```

#### Files to Create/Modify
| File | Action | Description |
|------|--------|-------------|
| `internal/hotkey/hotkey.go` | CREATE | Hotkey manager |
| `internal/hotkey/hotkey_darwin.go` | CREATE | macOS-specific bindings |
| `internal/config/config.go` | MODIFY | Add HotkeyConfig struct |
| `main.go` | MODIFY | Initialize hotkey manager |
| `frontend/src/stores/audio.ts` | MODIFY | Add PTT state |
| `frontend/src/lib/Controls.svelte` | MODIFY | PTT indicator |

#### Acceptance Criteria
- [ ] Hotkey registers on app start
- [ ] Holding hotkey activates mic
- [ ] Releasing hotkey triggers STT
- [ ] Visual indicator shows PTT active
- [ ] Hotkey is configurable
- [ ] Graceful handling if hotkey already registered

---

### 1.2 Live Captions/Subtitles

**Effort**: 0.5 day  
**Owner**: TBD

#### Requirements
- Display transcribed speech as floating captions
- Show both user speech and assistant responses
- Auto-fade after 5 seconds
- Toggleable via UI control
- Accessible: high contrast, adjustable font size

#### Technical Approach
```
Event: Already exists - "audio:transcript" and "cortex:response"
Component: frontend/src/lib/Captions.svelte (new)
Store: frontend/src/stores/captions.ts (new)
Config: Add captions.enabled, captions.font_size, captions.duration
```

#### Files to Create/Modify
| File | Action | Description |
|------|--------|-------------|
| `frontend/src/lib/Captions.svelte` | CREATE | Caption overlay component |
| `frontend/src/stores/captions.ts` | CREATE | Caption state store |
| `frontend/src/App.svelte` | MODIFY | Add Captions component |
| `frontend/src/lib/Controls.svelte` | MODIFY | Add caption toggle button |
| `internal/config/config.go` | MODIFY | Add CaptionsConfig |

#### Acceptance Criteria
- [ ] User speech appears as caption
- [ ] Assistant response appears as caption
- [ ] Captions auto-fade after timeout
- [ ] Toggle button works
- [ ] Font size is configurable
- [ ] High contrast mode available

---

### 1.3 System Tray Integration

**Effort**: 0.5 day  
**Owner**: TBD

#### Requirements
- System tray icon with context menu
- Menu items: Show/Hide, Toggle Mic, Toggle Speaker, Quit
- Icon changes based on state (idle/listening/speaking)
- Click on icon shows/hides main window

#### Technical Approach
```
API: Wails v2 systray (runtime.WindowShow/Hide)
Location: internal/systray/systray.go (new)
Icons: assets/icons/tray_*.png (idle, listening, speaking)
```

#### Files to Create/Modify
| File | Action | Description |
|------|--------|-------------|
| `internal/systray/systray.go` | CREATE | System tray manager |
| `assets/icons/tray_idle.png` | CREATE | Idle state icon |
| `assets/icons/tray_listening.png` | CREATE | Listening state icon |
| `assets/icons/tray_speaking.png` | CREATE | Speaking state icon |
| `main.go` | MODIFY | Initialize systray |
| `internal/bridge/audio_bridge.go` | MODIFY | Emit state changes for tray |

#### Acceptance Criteria
- [ ] Tray icon appears on app start
- [ ] Right-click shows menu
- [ ] Show/Hide toggles window visibility
- [ ] Mic/Speaker toggles work
- [ ] Icon reflects current state
- [ ] Quit cleanly exits app

---

## Phase 2: Voice UX Enhancement

**Duration**: 2 days  
**Dependencies**: Phase 1 complete (for testing)  
**Parallelizable**: NO - Core audio pipeline changes

### 2.1 Improved Barge-in with AEC

**Effort**: 2 days  
**Owner**: TBD

#### Requirements
- Replace 500ms echo cooldown with proper AEC
- User can interrupt TTS naturally
- No false triggers from speaker echo
- Minimal latency impact

#### Technical Approach
```
Library: pion/mediadevices (WebRTC) OR xiph/speex (via cgo)
Recommendation: Start with Speex - simpler, proven, lighter weight

Flow:
1. Capture TTS output waveform as reference signal
2. Apply AEC to mic input using reference
3. Run VAD on cleaned signal
4. Remove hardcoded 500ms cooldown
```

#### Files to Create/Modify
| File | Action | Description |
|------|--------|-------------|
| `internal/audio/aec.go` | CREATE | Acoustic echo cancellation |
| `internal/audio/aec_speex.go` | CREATE | Speex AEC implementation |
| `internal/audio/manager.go` | MODIFY | Integrate AEC into pipeline |
| `internal/bridge/audio_bridge.go` | MODIFY | Remove cooldown, use AEC |
| `go.mod` | MODIFY | Add Speex dependency |

#### Architecture
```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ Microphone  │────►│     AEC     │────►│     VAD     │
└─────────────┘     └──────┬──────┘     └─────────────┘
                          │
                   Reference Signal
                          │
┌─────────────┐     ┌─────┴───────┐
│   Speaker   │◄────│ TTS Output  │
└─────────────┘     └─────────────┘
```

#### Acceptance Criteria
- [ ] User can interrupt TTS mid-speech
- [ ] No false triggers when TTS playing
- [ ] Latency < 100ms for barge-in detection
- [ ] Works with all TTS providers
- [ ] Graceful fallback if AEC unavailable

---

## Phase 3: Persistence Layer

**Duration**: 2 days  
**Dependencies**: Phase 1 complete  
**Parallelizable**: YES - Can run alongside Phase 2

### 3.1 Display Cache (Conversation History)

**Effort**: 2 days  
**Owner**: TBD

#### Requirements
- Store conversation history locally for UI display
- Note: CortexBrain is authoritative for memory - this is display cache only
- Search conversations by content
- Export to Markdown/JSON
- Clear history option

#### Technical Approach
```
Storage: SQLite via mattn/go-sqlite3
Location: ~/.cortexavatar/history.db
Schema: See below
UI: Sidebar or modal with conversation list
```

#### Database Schema
```sql
-- Conversations
CREATE TABLE conversations (
    id TEXT PRIMARY KEY,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    persona TEXT NOT NULL,
    title TEXT
);

-- Messages
CREATE TABLE messages (
    id TEXT PRIMARY KEY,
    conversation_id TEXT NOT NULL,
    role TEXT NOT NULL,  -- 'user' or 'assistant'
    content TEXT NOT NULL,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (conversation_id) REFERENCES conversations(id)
);

-- Full-text search
CREATE VIRTUAL TABLE messages_fts USING fts5(content, content=messages, content_rowid=rowid);
```

#### Files to Create/Modify
| File | Action | Description |
|------|--------|-------------|
| `internal/history/history.go` | CREATE | History manager |
| `internal/history/db.go` | CREATE | SQLite operations |
| `internal/history/export.go` | CREATE | Export functions |
| `internal/bridge/audio_bridge.go` | MODIFY | Save messages to history |
| `frontend/src/lib/History.svelte` | CREATE | History UI component |
| `frontend/src/stores/history.ts` | CREATE | History state store |
| `go.mod` | MODIFY | Add sqlite3 dependency |

#### Acceptance Criteria
- [ ] Messages auto-saved to SQLite
- [ ] History UI shows past conversations
- [ ] Search works across all messages
- [ ] Export to Markdown works
- [ ] Export to JSON works
- [ ] Clear history works
- [ ] Persists across app restarts

---

## Phase 4: Hands-Free Mode

**Duration**: 2-3 days  
**Dependencies**: Phase 2 complete (AEC needed for good wake word experience)  
**Parallelizable**: NO - Requires stable audio pipeline

### 4.1 Wake Word Detection

**Effort**: 2-3 days  
**Owner**: TBD

#### Requirements
- Always-on low-power wake word listening
- Default wake word: "Hey Cortex"
- On detection: activate listening mode
- After response: return to wake word mode
- Optional feature (requires Porcupine library)

#### Technical Approach
```
Library: Picovoice/porcupine (Go SDK)
Alternative: openWakeWord (via subprocess, lower quality)
Recommendation: Porcupine with abstraction layer for future alternatives

Flow:
1. App starts in wake word mode
2. Porcupine processes audio stream continuously
3. On wake word detection → StartListening()
4. After STT + response → return to wake word mode
```

#### Files to Create/Modify
| File | Action | Description |
|------|--------|-------------|
| `internal/wakeword/wakeword.go` | CREATE | Wake word interface |
| `internal/wakeword/porcupine.go` | CREATE | Porcupine implementation |
| `internal/wakeword/disabled.go` | CREATE | Stub when unavailable |
| `internal/config/config.go` | MODIFY | Add WakeWordConfig |
| `internal/bridge/audio_bridge.go` | MODIFY | Integrate wake word |
| `assets/wakeword/hey_cortex.ppn` | CREATE | Custom wake word model |

#### State Machine
```
┌─────────────────────────────────────────────────────────┐
│                                                          │
│    ┌──────────┐  wake word   ┌───────────┐              │
│    │  WAKE    │─────────────►│ LISTENING │              │
│    │  WORD    │              │           │              │
│    │  MODE    │◄─────────────│           │              │
│    └──────────┘  response    └─────┬─────┘              │
│         ▲        complete          │                     │
│         │                          │ speech              │
│         │                          │ detected            │
│         │                          ▼                     │
│         │                    ┌───────────┐              │
│         │                    │PROCESSING │              │
│         └────────────────────│  (STT)    │              │
│              timeout         └───────────┘              │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

#### Acceptance Criteria
- [ ] Wake word activates listening
- [ ] Returns to wake word mode after response
- [ ] Works with AEC (no self-trigger)
- [ ] Configurable sensitivity
- [ ] Graceful handling if Porcupine unavailable
- [ ] Low CPU usage in wake word mode

---

## Phase 5: Integration & Documentation

**Duration**: 1 day  
**Dependencies**: All phases complete  
**Parallelizable**: Partially

### 5.1 Integration Testing

**Effort**: 0.5 day

#### Test Scenarios
| # | Scenario | Components |
|---|----------|------------|
| 1 | PTT → STT → Response → TTS | Hotkey, STT, A2A, TTS |
| 2 | Wake word → Conversation → Return | Wake word, full pipeline |
| 3 | Barge-in during TTS | AEC, VAD, TTS cancel |
| 4 | History search and export | SQLite, UI |
| 5 | System tray controls | Systray, AudioBridge |
| 6 | Caption display | Events, Svelte component |

### 5.2 Documentation Updates

**Effort**: 0.5 day

#### Files to Update
| File | Updates |
|------|---------|
| `README.md` | New features, setup instructions |
| `CLAUDE.md` | New components, troubleshooting |
| `docs/TROUBLESHOOTING.md` | New issue categories |
| `docs/CONFIGURATION.md` | CREATE - Full config reference |

---

## Dependency Graph

```
Phase 0 (Planning)
    │
    ▼
Phase 1 (Foundation) ────────────────────┐
    │                                     │
    ├── 1.1 Push-to-Talk ──┐              │
    ├── 1.2 Live Captions ─┼─► Can run    │
    └── 1.3 System Tray ───┘   in parallel│
                                          │
    ┌─────────────────────────────────────┘
    │
    ▼
Phase 2 (Voice UX) ◄────────────────────┐
    │                                    │
    └── 2.1 Barge-in AEC                 │
              │                          │
              │         Phase 3 (Persistence)
              │             │
              │             └── 3.1 Display Cache
              │                     │
              ▼                     │
Phase 4 (Hands-Free) ◄──────────────┘
    │
    └── 4.1 Wake Word
              │
              ▼
Phase 5 (Integration)
    │
    ├── 5.1 Testing
    └── 5.2 Documentation
              │
              ▼
         RELEASE v1.1
```

---

## Resource Requirements

### Go Dependencies
```
golang.design/x/hotkey     # Global hotkeys
github.com/mattn/go-sqlite3 # SQLite
github.com/Picovoice/porcupine/binding/go # Wake word (optional)
```

### Frontend Dependencies
```
None - using existing Svelte/Threlte stack
```

### External Requirements
- Porcupine access key (free for personal use)
- Custom wake word model training (Picovoice console)

---

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Speex AEC quality insufficient | Medium | High | Have WebRTC fallback plan |
| Porcupine licensing issues | Low | Medium | openWakeWord as alternative |
| Global hotkey conflicts | Medium | Low | Make configurable, detect conflicts |
| SQLite performance with large history | Low | Low | Add pagination, limit queries |

---

## Success Metrics

| Metric | Target |
|--------|--------|
| Barge-in latency | < 100ms |
| Wake word accuracy | > 95% |
| False wake rate | < 1 per hour |
| PTT response time | < 50ms |
| History search time | < 100ms for 10k messages |

---

## Parallel Execution Strategy

### Agent Assignment (Proposed)

| Phase | Component | Agent/Resource |
|-------|-----------|----------------|
| 1.1 | Push-to-Talk | Backend Engineer |
| 1.2 | Live Captions | Frontend Engineer |
| 1.3 | System Tray | Backend Engineer |
| 2.1 | Barge-in AEC | Audio Specialist |
| 3.1 | Display Cache | Backend Engineer |
| 4.1 | Wake Word | Audio Specialist |
| 5.x | Integration | All |

### Timeline (Parallel Execution)

```
Day 1-2:  Phase 1 (all 3 features in parallel)
Day 3-4:  Phase 2 (AEC) + Phase 3 (History) in parallel
Day 5-7:  Phase 4 (Wake Word)
Day 8:    Phase 5 (Integration + Docs)
Day 9-10: Buffer for issues
```

---

## Approval & Sign-off

- [ ] Architecture review complete
- [ ] Resource allocation confirmed
- [ ] Timeline approved
- [ ] Risk mitigations accepted

**Approved by**: _________________  
**Date**: _________________

---

## Changelog

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2026-01-07 | Sisyphus | Initial plan |
